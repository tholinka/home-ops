---
# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.10.0
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.32.4

clusterName: kubernetes
endpoint: https://192.168.20.2:6443

clusterPodNets:
  - 10.69.0.0/16
  #- 2001:cafe:42::/56
clusterSvcNets:
  - 10.96.0.0/16
  #- 2001:cafe:43::/112

additionalApiServerCertSans: &sans
  - 192.168.20.2
  - cluster.servers.internal
  - 127.0.0.1
additionalMachineCertSans: *sans

# Disable built-in Flannel to use Cilium
cniConfig:
  name: none

nodes:
  - hostname: p1
    ipAddress: 192.168.20.51
    installDiskSelector:
      serial: '0x31f66767'
    talosImageURL: factory.talos.dev/installer/ee21ef4a5ef808a9b7484cc0dda0f25075021691c8c09a276591eedb638ea1f9 # single board computer| raspberry pi series
    controlPlane: false
    networkInterfaces:
      - &interface
        interface: eth0
        dhcp: false
        addresses:
          - 192.168.20.51/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.20.1
        mtu: 1500
        vlans:
          - vlanId: 30
            mtu: 1500
            dhcp: false
            dhcpOptions:
              routeMetric: 4096
    patches:
      - |-
        ---
        machine:
          udev: # rename to standardized name for multus
            rules:
              - |-
                SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
                ATTR{address}=="dc:a6:32:ad:6e:81",ATTR{dev_id}=="0x0", ATTR{type}=="1",
                KERNEL=="end*", NAME="eth0"

  - hostname: c1
    ipAddress: 192.168.20.61
    installDisk: /dev/sda
    machineSpec:
      secureboot: false
    talosImageURL: &x64Image factory.talos.dev/installer/54046bcea0721cbff72c10bfe1374c2bc07ce6cff32be745f447150e19af00a6 # baremtal| i915, intel-ucode, mei| intel_iommu=on iommu=pt
    controlPlane: true
    networkInterfaces:
      - <<: *interface
        addresses:
          - 192.168.20.61/24
        vip: &vip
          ip: 192.168.20.2
    patches: &lenovoPatches
      - '@./patches/intel/machine-sysfs.yaml'
      - '@./patches/intel/machine-udev.yaml'
      - '@./patches/ethernet/lenovo.yaml'
      - '@./patches/large/machine-sysctls.yaml'
  - hostname: c2
    ipAddress: 192.168.20.62
    installDisk: /dev/sda
    machineSpec:
      secureboot: false
    talosImageURL: *x64Image
    controlPlane: true
    networkInterfaces:
      - <<: *interface
        addresses:
          - 192.168.20.62/24
        vip: *vip
    patches: *lenovoPatches
  - hostname: c3
    ipAddress: 192.168.20.63
    installDisk: /dev/sda
    machineSpec:
      secureboot: false
    talosImageURL: *x64Image
    controlPlane: true
    networkInterfaces:
      - <<: *interface
        addresses:
          - 192.168.20.63/24
        vip: *vip
    patches: *lenovoPatches
  - hostname: w1
    ipAddress: 192.168.20.71
    installDiskSelector:
      serial: 1922DD470802
    machineSpec:
      secureboot: false
    talosImageURL: *x64Image
    controlPlane: false
    networkInterfaces: # backup 1GbE port: 80:e8:2c:2f:b4:ad
      - <<: *interface
        addresses:
          - 192.168.20.71/24
    patches: &hpPatches
      - '@./patches/intel/machine-sysfs.yaml'
      - '@./patches/intel/machine-udev.yaml'
      - '@./patches/ethernet/usb.yaml'
      - '@./patches/large/machine-sysctls.yaml'
      - |-
        machine:
          sysfs:
            devices.system.cpu.cpu4.cpufreq.energy_performance_preference: balance_performance
            devices.system.cpu.cpu5.cpufreq.energy_performance_preference: balance_performance
  - hostname: w2
    ipAddress: 192.168.20.72
    installDiskSelector:
      serial: S4GNNF0N211290
    machineSpec:
      secureboot: false
    talosImageURL: *x64Image
    controlPlane: false
    networkInterfaces: # backup 1GbE port: e8:
      - <<: *interface
        addresses:
          - 192.168.20.72/24
    patches: *hpPatches
  - hostname: w3
    ipAddress: 192.168.20.73
    installDisk: /dev/sda
    machineSpec:
      secureboot: false
    talosImageURL: *x64Image
    controlPlane: false
    networkInterfaces: # backup 1GbE port: e8:
      - <<: *interface
        addresses:
          - 192.168.20.73/24
    patches: *hpPatches
  - hostname: w4
    ipAddress: 192.168.20.74
    installDiskSelector:
      serial: S4GNNF0N206772
    machineSpec:
      secureboot: false
    talosImageURL: *x64Image
    controlPlane: false
    networkInterfaces: # backup 1GbE port: e8:
      - <<: *interface
        addresses:
          - 192.168.20.74/24
    patches: *hpPatches
  - hostname: q1
    ipAddress: 192.168.20.101
    installDisk: /dev/sda
    machineSpec:
      secureboot: false
    talosImageURL: factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515 # cloud server| nocloud| qemu-guest-agent
    controlPlane: false
    networkInterfaces:
      - <<: *interface
        addresses:
          - 192.168.20.101/24
    patches:
      - '@./patches/large/machine-sysctls.yaml'

# Global patches
patches:
  - '@./patches/global/machine-features.yaml'
  - '@./patches/global/machine-files.yaml'
  - '@./patches/global/machine-kubelet.yaml'
  - '@./patches/global/machine-modules.yaml'
  - '@./patches/global/machine-network.yaml'
  - '@./patches/global/machine-sysctls.yaml'
  - '@./patches/global/machine-time.yaml'

# Controller patches
controlPlane:
  patches:
    - '@./patches/controller/admission-controller-patch.yaml'
    - '@./patches/controller/cluster.yaml'
    - '@./patches/controller/machine-features.yaml'
