---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/mutatingadmissionpolicybinding-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: kopia-maintenance-nfs
spec:
  policyName: kopia-maintenance-nfs
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/mutatingadmissionpolicy-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: kopia-maintenance-nfs
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - batch
        apiVersions:
          - v1
        operations:
          - CREATE
          - UPDATE
        resources:
          - jobs
  matchConditions:
    - name: has-kopia-maint-job-name-prefix
      expression: >
        object.metadata.name.startsWith("kopia-maint-nfs-")
    - name: repository-volume-does-not-exist
      expression: >
        !has(object.spec.template.spec.volumes) ||
        !object.spec.template.spec.volumes.exists(item, item.name == "repository")
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        # patches in order:
        # - runAsNonRoot: the pod-level securityContext sets runAsUser to 0, but the container-level securityContext has runAsNonRoot set
        # - mount nfs as /repository
        expression: >-
          [
            JSONPatch{
              op: "replace", path: "/spec/template/spec/containers/0/securityContext/runAsNonRoot",
              value: false
            },
            JSONPatch{
              op: "add", path: "/spec/template/spec/volumes/-",
              value: Object.spec.template.spec.volumes{
                name: "repository",
                nfs: Object.spec.template.spec.volumes.nfs{
                  server: "nas.servers.internal",
                  path: "/backups/VolsyncKopia"
                }
              }
            },
            JSONPatch{
              op: "add", path: "/spec/template/spec/containers/0/volumeMounts/-",
              value: Object.spec.template.spec.containers.volumeMounts{
                name: "repository",
                mountPath: "/repository"
              }
            }
          ]
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/mutatingadmissionpolicybinding-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: kopia-maintenance
spec:
  policyName: kopia-maintenance
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/mutatingadmissionpolicy-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: kopia-maintenance
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - batch
        apiVersions:
          - v1
        operations:
          - CREATE
          - UPDATE
        resources:
          - jobs
  matchConditions:
    - name: has-kopia-maint-job-name-prefix
      expression: >
        object.metadata.name.startsWith("kopia-maint")
    - name: node-selector-does-not-exist
      expression: >
        !has(object.spec.template.spec.nodeSelector)
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        # patches in order:
        # - don't run on rpi, as its very slow :)
        expression: >-
          [
            JSONPatch{
              op: "add", path: "/spec/template/spec/nodeSelector",
              value: Object.spec.template.spec.nodeSelector{}
            },
            JSONPatch{
              op: "add", path: "/spec/template/spec/nodeSelector/kubernetes.io~1arch",
              value: "amd64"
            }
          ]
